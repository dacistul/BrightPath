<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initisaual-scale=1" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      crossorigin="anonymous"
    />

    <title>{% block title %}Home{% endblock %}</title>
    {% block extra_css %}{% endblock %}
    
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(to bottom, #a2b1ff, #e397ef);
        background-repeat: no-repeat;
        background-attachment: fixed;
      }
    
      header {
        background-color: #a2b1ff;
        color: white;
        padding: 20px;
      }
    
      h1 {
        margin: 0;
      }
    
      nav {
        background-color: #a2b1ff;
        color: white;
        padding: 10px;
      }
    
      nav ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
    
      nav ul li {
        display: inline;
        margin-right: 10px;
      }
    
      nav ul li:first-child {
        margin-left: 50px;
      }
    
      nav ul li:not(:last-child) {
        margin-right: 50px;
      }
    
      nav ul li a {
        color: white;
        text-decoration: none;
      }
    
      html,
      body {
        height: 100%;
        margin: 0;
      }
    
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
    
      main {
        flex: 1;
        /* This makes the main content to expand and take available space */
      }
    
      footer {
        /* Add your footer styles here */
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        background-color: #e397ef;
        /* Example background color */
        color: white;
        text-align: center;
        padding: 20px;
      }
    
      .image-container {
        display: flex;
        justify-content: space-around;
      }
    
      .image-container img {
        width: 50%;
        height: auto;
      }
    
      .image-container img:first-child {
        width: 25%;
      }
    
      .sub-image-container {
        display: flex;
        margin-top: 10px;
      }
    
      .sub-image-container img {
        width: 10%;
        height: auto;
        margin-right: 10px;
      }
    
      .sub-image-container p {
        width: 90%;
      }
    
    
      /*chat style*/
      .chat-container {
        position: fixed;
        bottom: 75px;
        /* Adjust this to leave space for the button */
        right: 20px;
        width: 300px;
        height: 400px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 10px;
        display: none;
        flex-direction: column;
    
        z-index: 1000;
        /* Ensure it is above the button */
      }
    
      .chat-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #a2b1ff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
        z-index: 500;
        /* Ensure it stays below the chat container */
      }
    
      .chat-header {
        background: #a2b1ff;
        padding: 23px;
        color: white;
        display: flex;
        justify-content: center;
        /* Centers the title horizontally */
        align-items: center;
        position: relative;
      }
    
      .chat-header h4 {
        margin: 0;
        position: absolute;
        /* Absolute positioning to center with back button */
        left: 50%;
        transform: translateX(-50%);
        /* Perfectly centers the title */
        font-size: 20px;
        /* Adjust title size if needed */
        font-weight: bold;
      }
    
    
      .chat-messages {
        /* flex-grow: 1;
          overflow-y: auto;
          padding: 10px;*/
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border-top: 1px solid #ccc;
      }
    
      .chat-input-container {
        display: flex;
        border-top: 1px solid #ccc;
        padding: 10px;
    
        align-items: center;
        position: sticky;
        bottom: 0;
      }
    
      .chat-input-container input {
        flex-grow: 1;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
      }
    
      .chat-input-container button {
        margin-left: 5px;
        background: #a2b1ff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
      }
    
      /*teacher list style*/
      #professor-list h3 {
        color: white;
        font-size: 18px;
        /*font-weight: bold;*/
        background-color: #c8d0f4;
      }
    
      #professor-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 150px;
        overflow-y: auto;
      }
    
      #professor-list li {
        padding: 10px;
        cursor: pointer;
        color: #a2b1ff;
        border-bottom: 1px solid #ccc;
      }
    
      #professor-list li:hover {
        background: #eee;
      }
    
      /*student list style*/
    
      #student-list h3 {
        color: white;
        font-size: 18px;
        /*font-weight: bold;*/
        background-color: #c8d0f4;
      }
    
      #student-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 150px;
        overflow-y: auto;
      }
    
      #student-list li {
        padding: 10px;
        cursor: pointer;
        color: #a2b1ff;
        border-bottom: 1px solid #ccc;
      }
    
      #student-list li:hover {
        background: #eee;
      }
    
      #chat-body {
        height: 200px;
        overflow-y: auto;
        padding: 10px;
      }
    
      #chat-footer {
        display: flex;
        align-items: center;
        padding: 10px;
      }
    
      #chat-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
      }
    
      #chat-send {
        background: #6a5acd;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        margin-left: 10px;
        cursor: pointer;
      }
    
      #chat-send:hover {
        background: #5a4cad;
      }
    
      /*back button*/
      #back-button {
    
        position: absolute;
        left: 10px;
        /* Moves the button further to the left */
        top: 50%;
        transform: translateY(-50%);
        /* Vertically centers the button */
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        /* Adjust size for visibility */
        cursor: pointer;
      }
    
      #back-button i {
        color: white;
        /* Arrow color */
      }
    
      #back-button:hover {
        opacity: 0.8;
        /* Subtle hover effect */
      }
    
      .sent-message {
        background-color: rgb(162, 216, 207);
        /* Light green for sent messages */
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 10px;
        max-width: 80%;
        margin-left: auto;
        align-self: flex-end;
        /* Align to the right for sent messages */
        text-align: left;
      }
    
      .received-message {
        background-color: #e5a9e6;
        /* Light gray for received messages */
        padding: 5px;
        margin-bottom: 5px;
        border-radius: 10px;
        max-width: 80%;
        align-self: flex-start;
        /* Align to the left for received messages */
        text-align: left;
      }

      /* Translation dropdown */
      .language-dropdown {
        background-color: transparent; /* Make the dropdown background transparent */
        border: none; /* Remove border for cleaner appearance */
      }

      .language-dropdown .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px; /* Space between flag and text */
        color: #fff; /* Adjust text color for readability */
        padding: 5px; /* Smaller padding for compact design */
      }

      .language-dropdown .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.1); /* Subtle hover effect */
      }

      .navbar-nav .nav-item.dropdown .nav-link img {
        width: 20px;
        height: 15px;
      }

    </style>

  </head>
  <body>
    <nav class="navbar navbar-expand-md bg-#a2b1ff navbar-dark">
      <img src="/static/icon.png" alt="logo" width="90" height="90">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav mr-auto">
          {% if user.is_authenticated %}
            {% if current_user.account_type == 'professor' %}
              <li class="nav-item">
                <a class="nav-link" id="home" href="/">{{ _("Home") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="achievements" href="/achievements">{{ _("Achievements") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="account" href="/account">{{ _("My Courses") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="upload" href="/upload">{{ _("Upload") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="logout" href="/logout">{{ _("Logout") }}</a>
              </li>
            {% elif current_user.account_type == 'student' %}
              <li class="nav-item">
                <a class="nav-link" id="home" href="/">{{ _("Home") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="achievements" href="/achievements">{{ _("Achievements") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="account" href="/account">{{ _("My Courses") }}</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="logout" href="/logout">{{ _("Logout") }}</a>
              </li>
            {% endif %}
          {% else %}
            <li class="nav-item">
              <a class="nav-link" id="home" href="/home">{{ _("Home") }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="login" href="/login">{{ _("Login") }}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="signup" href="/signup">{{ _("Sign up") }}</a>
            </li>
          {% endif %}
        </ul>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ _("Language") }}</a>
            <div class="dropdown-menu dropdown-menu-right language-dropdown" aria-labelledby="languageDropdown">
              <a class="dropdown-item lang-switch" href="#" data-lang="en">
                <img src="/static/uk.png" alt="English" width="20" height="15"> English
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="ro">
                <img src="/static/romania.png" alt="Romanian" width="20" height="15"> Română
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="it">
                <img src="/static/italy.png" alt="Italian" width="20" height="15"> Italiana
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="zh">
                <img src="/static/china.png" alt="Chinese" width="20" height="15"> 中国人
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="ja">
                <img src="/static/japan.png" alt="Japan" width="20" height="15"> 日本語
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="zu">
                <img src="/static/southaf.png" alt="SouthAfrican" width="20" height="15"> Zulu
              </a>
              <a class="dropdown-item lang-switch" href="#" data-lang="ha">
                <img src="/static/nigeria.png" alt="Nigerian" width="20" height="15"> Hausa
              </a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <script>
      function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      document.querySelectorAll('.lang-switch').forEach(function (element) {
        element.addEventListener('click', function (event) {
          event.preventDefault();
    
          const selectedLang = this.getAttribute('data-lang');
          setCookie('lang', selectedLang, 1);
          const url = new URL(window.location.href);
          url.searchParams.set('lang', selectedLang);
    
          window.location.href = url.toString();
        });
      });

      window.addEventListener('load', function () {
        const lang = getCookie('lang');
        if (lang) {
          const url = new URL(window.location.href);
          if (url.searchParams.get('lang') !== lang) {
            url.searchParams.set('lang', lang);
            window.location.href = url.toString();
          }
        }
      });
    </script>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %} {% if category ==
    'error' %}
    <div class="alert alert-danger alter-dismissable fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% else %}
    <div class="alert alert-success alter-dismissable fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    {% endif %} {% endfor %} {% endif %} {% endwith %}

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if category == 'error' %}
          <div class="alert alert-danger alter-dismissable fade show" rolw="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert">
              <span area-hidden="true"> &times; </span>
            </button>
          </div>
        {% else %}
      <div class="alert alert-success alter-dismissable fade show" rolw="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert">
          <span area-hidden="true"> &times; </span>
        </button>
      </div>
      {% endif %}
      {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="container">{% block content %} {% endblock %}</div>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

{% block javascript %}
    <script type="text/javascript">
      function deleteNote(noteId) {
  fetch("/delete-note", {
    method: "POST",
    body: JSON.stringify({ noteId: noteId }),
  }).then((_res) => {
    window.location.href = "/";
  });
  }
</script>

{% endblock %}
<footer>
  <!--chat window-->

  {% if user.is_authenticated %}
<div id="chat-container" class="chat-container">
  <div id="chat-header" class="chat-header">
    <button id="back-button" onclick="goBackToList()" style="background: none; border: none; visibility: hidden;">
      <i class="fa fa-arrow-left"></i>
    </button>
      <h4>{{_("Chat")}}</h4>
  </div>

  <!-- Display professor list only if the user is a student -->
  {% if current_user.account_type == 'student' %}
        <div id="professor-list">
          <h3>{{_("Professors")}}</h3>
            <ul>
                {% for professor in g.professors %}
                    <li onclick="startChat('{{ professor.id }}')">{{ professor.username }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <!-- Display the student list if the user is a professor -->
    {% if current_user.account_type == 'professor' %}
        <div id="student-list">
          <h3>{{_("Students")}}</h3>
            <ul>
                {% for student in g.students %}
                    <li onclick="startChat('{{ student.id }}')">{{ student.username }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}


  <div id="chat-messages" class="chat-messages">
    <!-- Messages will be dynamically loaded here -->
  </div>

  <div class="chat-input-container" style="display: none;">
    <input id="chat-input" type="text" placeholder="{{_("Type a message...")}}" />
    <button id="send-chat" onclick="sendMessage()">{{_("Send")}}</button>
  </div>
</div>

<button id="chat-button" class="chat-button" onclick="toggleChat()">{{_("Chat")}}</button>
{% endif %}
<script>
  const currentUserRole = "{{ current_user.account_type }}"; // Determine if the user is a professor or student
  const currentUserId = "{{ current_user.id }}";
  const currentUsername = "{{ current_user.username }}";

  function toggleChat() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.style.display = chatContainer.style.display === 'none' ? 'flex' : 'none';
  }

  function startChat(professorOrStudentId) {
    fetch(`/start_chat/${professorOrStudentId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide the appropriate list (professor or student)
        if (currentUserRole === 'student') {
          document.getElementById('professor-list').style.display = 'none';
        } else if (currentUserRole === 'professor') {
          document.getElementById('student-list').style.display = 'none';
        }

        // Show the chat window and update chat content
        const chatContainer = document.getElementById('chat-container');
        chatContainer.style.display = 'flex';
        chatContainer.dataset.chatId = data.chatId;

        // Show the chat input area
        document.querySelector('.chat-input-container').style.display = 'flex';

        // Show back button and update chat header
        const backButton = document.getElementById('back-button');
        backButton.style.visibility = 'visible';

        const chatHeader = document.getElementById('chat-header');
        const name = data.professorName || data.studentName; // Update for either role
        chatHeader.querySelector('h4').innerText = '{{_("Chat with")}} ' + `${name}`;

        // Load chat messages
        loadMessages(data.chatId);
      } else {
        alert(data.error || "Failed to start chat. Please try again.");
      }
    })
    .catch(error => {
      console.error("Error starting chat:", error);
    });
  }

  function goBackToList() {
    // Show the correct user list based on the role
    if (currentUserRole === 'student') {
        document.getElementById('professor-list').style.display = 'block';
    } else if (currentUserRole === 'professor') {
        document.getElementById('student-list').style.display = 'block';
    }

    // Reset the chat view but keep the chat window open
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = ''; // Clear the chat messages

    const chatHeader = document.getElementById('chat-header');
    chatHeader.querySelector('h4').innerText = '{{ _("Chat")}}'; // Reset header text

    // Keep the chat container open
    const chatContainer = document.getElementById('chat-container');
    chatContainer.style.display = 'block'; // Ensure it's visible

    // Hide only the back button
    const backButton = document.getElementById('back-button');
    backButton.style.visibility = 'hidden';
    document.querySelector('.chat-input-container').style.display = 'none';
}

  function loadMessages(chatId) {
    fetch(`/get_messages/${chatId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const chatMessages = document.getElementById('chat-messages');
          chatMessages.innerHTML = ''; // Clear any existing messages

          data.messages.forEach(msg => {
            const messageElement = document.createElement('div');
            messageElement.className = msg.senderId === currentUserId ? 'sent-message' : 'received-message';

            messageElement.innerHTML = `
              <div class="message-content">
                <strong>${msg.senderUsername}:</strong> ${msg.content}
              </div>
              <div class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            `;

            chatMessages.appendChild(messageElement);
          });

          chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
          alert(data.error || "Failed to load messages.");
        }
      })
      .catch(error => {
        console.error("Error loading messages:", error);
      });
  }

  function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    const chatId = document.getElementById('chat-container').dataset.chatId;

    if (!message) {
        alert("Message cannot be empty!");
        return;
    }

    fetch('/send_message', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chatId: chatId, message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const chatMessages = document.getElementById('chat-messages');
            const newMessage = document.createElement('div');
            
            
            const senderUsername = currentUserId === data.message.senderId ? currentUsername : data.message.senderUsername;
            const messageTimestamp = new Date(data.message.timestamp);

            newMessage.innerHTML = `
                <strong>${senderUsername}:</strong> ${data.message.content}
                <div class="message-timestamp">${messageTimestamp.toLocaleTimeString()}</div>
            `;
            
            newMessage.className = currentUserId === data.message.senderId ? 'sent-message' : 'received-message';
            chatMessages.appendChild(newMessage);

            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        } else {
            alert(data.error || "Failed to send message. Please try again.");
        }
    })
    .catch(error => {
        console.error("Error sending message:", error);
    });
  }

  const chatInputField = document.getElementById('chat-input');
  chatInputField.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      sendMessage();
      event.preventDefault(); // Prevents new line creation
    }
  });
</script>

  <div class="container-footer">
      <p>&copy; {{_("2024 Bright Path. All rights reserved.")}}</p>
  </div>
</footer> 

</body>
</html>